#!/bin/bash
#
export GMK_THREADS=1
#
type gmkpack >/dev/null 2>&1
if [ $? -ne 0 ] ; then
  echo "error : gmkpack could not be found."
  exit 1
else
  export GMKROOT=$(dirname $(dirname $(which gmkpack | awk '{print $NF}')))
fi
. $GMKROOT/aux/wrkpack.sh
#
# ------ Main settings --------------------------------------
#
# Fortran compiler options :
declare -A optfrt
# optfrt[4] = Optimal, as for operations : -O2
# optfrt[3] = Debugging                  : -g -O0
# optfrt[2] = Debugging + Bound checking : -g -O0 -Mbounds
# optfrt[1] = Preinitialisations to NaN  : 
# optfrt[0] = User-defined options
optfrt[0]=""
#
# Choose subscript (0/1/2/3) :
# --------------------------
Ofrt=3
#
# C compiler options :
optvcc="-O2 "
# CUDA compiler options
optccu=""
#
#
# Files in pack to ignore (obsolete/useless) :
# ------------------------------------------  
cat > $GMKWRKDIR/.ignored_files <<end_of_ignored_files
end_of_ignored_files
#
# Do you want to compile dependencies ? (yes/no)
# -----------------------------------
export DEP=yes
# If you compile dependencies, approve the following projects list :
export MKPROJECT="algor cmake ecfftw ifs ifsaux trans"
#
# Supplementary projects with autogenerated explicit interface blocks :
# -------------------------------------------------------------------  
export INTFB_PROJLIST=""
#
# Do you want to enable the recursive update control ? (yes/no) ?
# --------------------------------------------------
export ICS_RECURSIVE_UPDATE=yes
#
# Do you want to postpone the aborts on compilation errors to the end of the compilation step ? (yes/no) ?
# -------------------------------------------------------------------------------------------
export ICS_POSTPONE_ABORT=no
#
# Three compilation modes are possible : 
# full = full compilation (default value)
# incr = incremental compilation (from a starting to an ending level)
# off  = No compilation at all
# Choose compilation mode (full/incr/off) : 
# ---------------------------------------
export ICS_ICFMODE=full
# If you use the incremental compilation facility, select the top and bottom levels :
export ICS_START=
export ICS_STOP=
# Reduced starting list :
cat > $GMKWRKDIR/.reduced_starting_list <<end_of_reduced_starting_list
end_of_reduced_starting_list
#
# Do you want to output the compilation listings ? (yes/no)
# ----------------------------------------------
export ICS_LIST=yes
#
# Compilation timing report:
# ------------------------- 
# ICS_TIMING_REPORT = 0 (No report) = N (N most time consuming files)
export ICS_TIMING_REPORT=0
#
# Norms checker 2011 severity :
# ---------------------------  
# ICS_NC_SEVERITY = 0 (No report) or 1 (Severe,Warning) or 2 (+Informative)
# ICS_NC_SUPPRESS = "section.item:section.item" : suppressed messages
export ICS_NC_SEVERITY=2
export ICS_NC_SUPPRESS=""
export WHITELIST=
export GEN_WHITELIST=0
#
# Do you want to output the load map(s) ? (yes/no)
# -------------------------------------
export ICS_MAP=no
#
# Five libraries update are possible : 
# full  = full update (default value)
# user  = update user libraries only, not the dummy ones
# dummy = update dummy (user-mirror) libraries only, not the user ones
# unsx  = update unsatisfied external libraries only, not the user/dummy ones
# off   = no update at all
# Choose the libraries update mode (full/user/dummy/unsx/off) : 
# --------------------------------
export ICS_UPDLIBS=full
#
#
# ODB Maximum number of updates supported at compile time
odb_nmxupd=3
#
#
# Do you want to make any executable ? (yes/no)
# ----------------------------------
Load=yes
#
# If you want to make any executable, approve the following ones :
# (libraries should be properly ordered from top to bottom for each binary)
#
# Binary "aatestprog" :
cat > $GMKWRKDIR/.aatestprog_link <<end_of_aatestprog_link
EXEC=AATESTPROG
ENTRY=trans/programs/aatestprog.o
end_of_aatestprog_link
# BACKGROUND LIBRARIES (from top to bottom) :
cat > $GMKWRKDIR/.aatestprog_libs <<end_of_aatestprog_libs
/home/ms/fr/sor/pack/45_etrans.01.PGI209.cpu/lib/libtrans.main.a
/home/ms/fr/sor/pack/45_etrans.01.PGI209.cpu/lib/libprograms-trans.main.a
/home/ms/fr/sor/pack/45_etrans.01.PGI209.cpu/lib/libalgor.main.a
/home/ms/fr/sor/pack/45_etrans.01.PGI209.cpu/lib/libifsaux.main.a
/home/ms/fr/sor/pack/45_etrans.01.PGI209.cpu/lib/libprograms-ifsaux.main.a
end_of_aatestprog_libs
# LOW-LEVEL LIBRARIES (from top to bottom) :
cat > $GMKWRKDIR/.aatestprog_sys <<end_of_aatestprog_sys
-L/home/ms/fr/sor/install/PGI209/eccodes-2.14.0/lib -leccodes_f90 -leccodes
-L/home/ms/fr/sor/install/PGI209/lapack-3.2.1/lib -llapack -lblas
end_of_aatestprog_sys
# LOADER AND OPTIONS :
cat > $GMKWRKDIR/.aatestprog_load <<end_of_aatestprog_load
/home/ms/fr/sor/gmkpack_support/wrapper/PGI209/mpif90 -fopenmp -Wl,-rpath,/home/ms/fr/sor/install/PGI209/eccodes-2.14.0/lib -Wl,-rpath,/home/ms/fr/sor/install/PGI209/lapack-3.2.1/lib -Wl,-rpath,/opt/nvidia/hpc_sdk/Linux_x86_64/20.9/comm_libs/nvshmem/lib -Wl,-rpath,/opt/nvidia/hpc_sdk/Linux_x86_64/20.9/comm_libs/nccl/lib -Wl,-rpath,/opt/nvidia/hpc_sdk/Linux_x86_64/20.9/comm_libs/mpi/lib -Wl,-rpath,/opt/nvidia/hpc_sdk/Linux_x86_64/20.9/math_libs/lib64 -Wl,-rpath,/opt/nvidia/hpc_sdk/Linux_x86_64/20.9/compilers/lib -Wl,-rpath,/opt/nvidia/hpc_sdk/Linux_x86_64/20.9/cuda/lib64
end_of_aatestprog_load
#
# Libraries in hub : do you want to re-configure even if the build directory exists ? (ON/OFF) : 
# ---------------------------------------------------------------------------------
export GMK_RECONFIGURE=OFF
#
# Libraries in hub : do you want to compile packages ? (ON/OFF) : 
# --------------------------------------------------
export GMK_MAKE=ON
#
# Libraries in hub : do you want to test libraries ? (ON/OFF) : 
# -----------------------------------------------------------
export GMK_TEST=OFF
# Confirm which libraires to test :
#
# Libraries in hub : do you want to install packages ? (ON/OFF) : 
# --------------------------------------------------
export GMK_INSTALL=ON
#
#
# Blacklist file generator
# ------------------------

export ICS_BL_GENERATOR=


# Verboose level (0 or 1 or 2 or 3) :
# --------------

export ICS_ECHO=1

export GMKVIEW="main local"
export TARGET_PACK=/home/ms/fr/sor/pack/45_etrans.01.PGI209.cpu
# ----------------------------------------------------------------------------------
# ----------------------------------------------------------------------------------
#
#
# ------ Environment variables -----------------------------------------------------
#
$GMKROOT/aux/envvarpack.sh > $GMKWRKDIR/environment_variables
if [ $? -eq 0 ] ; then
  chmod 755 $GMKWRKDIR/environment_variables
  . $GMKWRKDIR/environment_variables
  \rm $GMKWRKDIR/environment_variables 
else
  echo "Error in envvarpack.sh :"
  cat $GMKWRKDIR/gmkpack_env_variables
  \rm -rf $GMKWRKDIR
  exit 1
fi
#
#
# IF YOU WISH TO CHANGE OR ADD ANY VARIABLE FROM THE CONFIGURATION FILE
# YOU SHOULD DO IT RIGHT BELOW THIS LINE !
#
#
#
$GMKROOT/aux/privarpack.sh > $GMKWRKDIR/environment_variables
chmod 755 $GMKWRKDIR/environment_variables
. $GMKWRKDIR/environment_variables
\rm $GMKWRKDIR/environment_variables
optfrt[4]="$OPT_FRTFLAGS" 
optfrt[3]="$DBG_FRTFLAGS"
optfrt[2]="$DBG_FRTFLAGS $BCD_FRTFLAGS"
optfrt[1]="$OPT_FRTFLAGS $NAN_FRTFLAGS"
export MyF90Flags="${optfrt[$Ofrt]}"
export MyF77Flags="${optfrt[$Ofrt]}"
export MyVccFlags="$optvcc"
export MyCcuFlags="$optccu"
#
export ODB_NMXUPD=$odb_nmxupd
#
echo
echo "This is $(basename $(grep ^THIS_GMKPACK $GMKROOT/util/gmkpack | awk -F"/" '{print $(NF-2)}')) running on a script made by gmkpack.6.8.1+cuda"

echo
$GMKROOT/aux/catenvpack.sh
#
# Compilation :
# -----------
$GMKROOT/aux/mkcplpack.sh
if [ $? -ne 0 ] ; then
  echo
  echo Finished on $(date)
  exit 1
fi
#
# Libraries :
# ---------
$GMKROOT/aux/libspack.sh
if [ $? -ne 0 ] ; then
  echo
  echo Finished on $(date)
  exit 1
fi
#
# Binaries :
# --------
if [ "$Load" = "yes" ] ; then
  $GMKROOT/aux/lnkpack.sh
  if [ $? -ne 0 ] ; then
    echo
    \rm -rf $GMKWRKDIR
    echo Finished on $(date)
    exit 1
  else
    exit 0
  fi
else
  echo
  \rm -rf $GMKWRKDIR
  echo Finished on $(date)
  exit 0
fi
